language: php
php:
    - '7.2'
sudo: false
branches:
  only:
    - master
#addons:
#  mariadb: '10.2'
env:
# in sequence :
# get the directory name after the sign "-"
# "git for-each-ref --sort=-taggerdate --count=1 --format '%(refname:short)' refs/tags" displays the last tag's shortname
# "git for-each-ref --sort=-taggerdate --count=1 --format '%(contents:subject)' refs/tags" displays the last tag's first line
# "git for-each-ref --sort=-taggerdate --count=1 --format '%(contents:body)' refs/tags" displays the last tag's 3d line and following ones
>
    - GLPI_PLUGIN_NAME=`echo $TRAVIS_BUILD_DIR | sed -e 's/^.*-//'`
      TRAVIS_TAG=`git for-each-ref --sort=-taggerdate --count=1 --format '%(refname:short)' refs/tags`
      RELEASE_NAME=`git for-each-ref --sort=-taggerdate --count=1 --format '%(contents:subject)' refs/tags`
      RELEASE_BODY=`git for-each-ref --sort=-taggerdate --count=1 --format '%(contents:body)' refs/tags`
install: true
script: true
after_success:
    - tar --transform "s%^%$GLPI_PLUGIN_NAME/%" --show-transformed -zcvf $GLPI_PLUGIN_NAME-$TRAVIS_TAG.tar.gz ajax front inc locales sql *.png *.xml *.php  LICENSE README.md
before_deploy:
  - brew install jshon
  - export ESCAPED_RELEASE_BODY=`jshon -s "$RELEASE_BODY"`
deploy:
  provider: releases
  api_key:
    secure: NL6/dm5xRR1AjqU6t09fETcGtdsiQHJvjq3G+agjc8uxn5LT237OMPvGotebmeZXJgYZ49gDGd88QZU3/NO8mf8N5UH5qllhmks8RsOV/3NoEPstAMj21GZDIzNSuQkCk25Kgub0nLNzxotFvnEz+GA/7ukJnCe0hFd2w1c7Bxz6X4pn5eXqKcH7Ia3PpJzid4WEL4t6E5s+4sTqB2WmBYEuleU0hDeFxivS8Pz+GJM9/XvYuRXsfFb7sfIHyq18tIEIizhtcpCdUMICMNqMmcfozItw5jESReaLG0rS6MwdADZZxki4ypPu8yOQBGnsA/d+N5Tv9kODDXsuSYk9SVhxW1jWO36MDpzKycvtEU3vLVNyO98bXmjWAJ3nmQM8AU6evF2gh1lHQZkybGgv6NBoEbRjzte21DNe1gP4wN1uLolBQNUPBwucked8jBMKkwa/LVWRw55RXnsoAUQEP6PJzVD6AWNafwqg06aFItkVkorPYTDjtDMP4N5ouOD99CKRpKtLXo4Aju0UEhcqmQ9E2LH7fLR9pi2MRKbztIs0mhLk77YWwhP1tGgjftBR53Hp+er93zcHGLGLlYo/5mChVsIYRu2B9iRulZhrHreVNGKu1S85Urim1A/KQsN7GPfFn+hFM0u+G2E8BvHDMmfIASZdNuBCjFRz19wQldI=
  skip_cleanup: true
  file: $GLPI_PLUGIN_NAME-$TRAVIS_TAG.tar.gz
  name: $RELEASE_NAME
  body: $ESCAPED_RELEASE_BODY
  prerelease: false
  on:
    repo: ericferon/glpi-$GLPI_PLUGIN_NAME
    tags: true
